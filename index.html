<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Conversor: Imagem/Documento → PDF (Bootstrap + Preview)</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

  <!-- html2canvas & jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>

  <!-- DOCX previewer (opcional p/ .docx) -->
  <script src="https://cdn.jsdelivr.net/npm/docx-preview@0.3.1/dist/docx-preview.min.js" defer></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docx-preview@0.3.1/dist/docx-preview.css" />

  <style>
    :root {
      --page-bg: #ffffff;
      --page-shadow: rgba(0, 0, 0, .1);
      --a4w: 794px;
      /* ~8.27in @96dpi */
      --a4h: 1123px;
      /* ~11.69in @96dpi */
    }

    body {
      background: linear-gradient(180deg, #f6f7fb, #eef1f7);
    }

    header {
      background: #0d6efd;
      color: #fff;
    }

    .uploader {
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      padding: 24px;
      background: #fff;
      cursor: pointer;
      transition: .2s ease;
    }

    .uploader.dragover {
      border-color: #0d6efd;
      background: #f1f6ff
    }

    .uploader input {
      display: none
    }

    .sidebar {
      position: sticky;
      top: 12px
    }

    /* Preview em páginas A4 */
    .preview-wrap {
      display: flex;
      flex-direction: column;
      gap: 24px
    }

    .page {
      width: var(--a4w);
      min-height: var(--a4h);
      background: var(--page-bg);
      box-shadow: 0 10px 24px var(--page-shadow);
      border-radius: 12px;
      margin: 0 auto;
      overflow: hidden;
      position: relative;
    }

    .page .content {
      padding: 24mm;
      /* margens padrão no preview */
      box-sizing: border-box;
    }

    .options .form-range {
      width: 100%
    }

    .thumb {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
    }

    .empty-state {
      text-align: center;
      color: #6b7280;
      padding: 40px 0;
    }

    footer.small {
      color: #6b7280
    }

    @media (max-width: 992px) {
      :root {
        --a4w: 620px;
        --a4h: 876px;
      }
    }

    @media (max-width: 768px) {
      :root {
        --a4w: 480px;
        --a4h: 678px;
      }
    }

    @media (max-width: 576px) {
      :root {
        --a4w: 340px;
        --a4h: 480px;
      }
    }
  </style>
</head>

<body>
  <header class="py-3 mb-4 shadow-sm">
    <div class="container d-flex align-items-center gap-3">
      <div class="bg-light rounded-3 p-2 d-flex align-items-center justify-content-center"
        style="width:44px;height:44px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
          class="bi bi-file-earmark-pdf" viewBox="0 0 16 16">
          <path
            d="M5.5 5.5A.5.5 0 0 0 5 6v4a.5.5 0 0 0 .5.5h1A1.5 1.5 0 0 0 8 9V7A1.5 1.5 0 0 0 6.5 5.5zm.5 1H7A.5.5 0 0 1 7.5 7v2A.5.5 0 0 1 7 9.5H6z" />
          <path
            d="M8.5 6a.5.5 0 0 1 .5-.5H11A1.5 1.5 0 0 1 12.5 7v2A1.5 1.5 0 0 1 11 10.5H9a.5.5 0 0 1-.5-.5zm1 .5V10h1A.5.5 0 0 0 11 9.5V7A.5.5 0 0 0 10.5 6.5z" />
          <path
            d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5zM10 4a1 1 0 0 1-1-1V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4z" />
        </svg>
      </div>
      <div>
        <h1 class="h4 mb-0">Conversor para PDF</h1>
        <div class="small opacity-75">Imagens (.png, .jpg, .webp), DOCX, HTML e TXT • Preview fiel ao PDF</div>
      </div>
    </div>
  </header>

  <main class="container pb-5">
    <div class="row g-4">
      <aside class="col-lg-4">
        <div class="sidebar">
          <div class="card mb-3">
            <div class="card-header">1) Envie seu arquivo</div>
            <div class="card-body">
              <label class="uploader w-100 text-center" id="dropZone">
                <input type="file" id="fileInput" accept="image/*,.docx,.html,.htm,.txt" />
                <div class="mb-2 fw-semibold">Arraste e solte aqui</div>
                <div class="small text-muted">ou clique para selecionar (PNG, JPG, WEBP, DOCX, HTML,
                  TXT)</div>
              </label>
              <div class="mt-3 d-flex align-items-center gap-2">
                <input class="form-control form-control-sm" id="projectName" value="meu-documento" />
                <span class="small text-muted">.pdf</span>
              </div>
            </div>
          </div>

          <div class="card mb-3 options">
            <div class="card-header">2) Configurações</div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-6">
                  <label class="form-label">Tamanho</label>
                  <select id="pageSize" class="form-select">
                    <option value="A4" selected>A4 (210×297mm)</option>
                    <option value="Letter">Carta (8.5×11in)</option>
                  </select>
                </div>
                <div class="col-6">
                  <label class="form-label">Orientação</label>
                  <select id="orientation" class="form-select">
                    <option value="portrait" selected>Retrato</option>
                    <option value="landscape">Paisagem</option>
                  </select>
                </div>
                <div class="col-12">
                  <label class="form-label">Margens (mm)</label>
                  <input type="range" class="form-range" min="5" max="35" step="1" id="marginRange" value="24">
                </div>
                <div class="col-12">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="fitToPage" checked>
                    <label class="form-check-label" for="fitToPage">Ajustar conteúdo à
                      página</label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="d-grid gap-2">
            <button class="btn btn-primary" id="btnGenerate">
              Converter para PDF
            </button>
            <button class="btn btn-outline-secondary" id="btnClear">Limpar</button>
          </div>

          <div class="mt-3">
            <div class="progress" role="progressbar" aria-label="Progresso" aria-valuemin="0" aria-valuemax="100">
              <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
            </div>
            <div class="form-text">O tempo depende do tamanho/quantidade de páginas.</div>
          </div>
        </div>
      </aside>

      <section class="col-lg-8">
        <div class="card">
          <div class="card-header d-flex align-items-center justify-content-between">
            <span>3) Preview (como ficará no PDF)</span>
            <div class="small text-muted" id="metaInfo">Nenhum arquivo carregado</div>
          </div>
          <div class="card-body">
            <div id="preview" class="preview-wrap">
              <div class="empty-state" id="emptyPreview">
                <p class="mb-1">Envie um arquivo para gerar o preview.</p>
                <p class="small mb-0">Suporta imagens, DOCX, HTML e TXT. Você pode ajustar tamanho,
                  orientação e margens.</p>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer class="container pb-5">
    <p class="small">Dica: para documentos longos (.docx/.html/.txt), o sistema faz a paginação automática no PDF
      com base na altura da página escolhida.</p>
  </footer>

  <script>
    // Utilidades de tamanho de página (pixels para o preview a ~96dpi)
    const PAGE_SIZES = {
      A4: { w: 794, h: 1123 },          // 210×297mm @96dpi aprox
      Letter: { w: 816, h: 1056 }       // 8.5×11in @96dpi
    };

    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

    const dropZone = $('#dropZone');
    const fileInput = $('#fileInput');
    const preview = $('#preview');
    const emptyPreview = $('#emptyPreview');
    const pageSizeSel = $('#pageSize');
    const orientationSel = $('#orientation');
    const marginRange = $('#marginRange');
    const fitToPageChk = $('#fitToPage');
    const btnGenerate = $('#btnGenerate');
    const btnClear = $('#btnClear');
    const progressBar = $('#progressBar');
    const metaInfo = $('#metaInfo');
    const projectName = $('#projectName');

    let currentFile = null;
    let renderedContainer = null; // container com o conteúdo unificado para render -> PDF

    // Drag & Drop
    ;['dragenter', 'dragover'].forEach(evt => {
      dropZone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('dragover'); });
    });
    ;['dragleave', 'drop'].forEach(evt => {
      dropZone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('dragover'); });
    });
    dropZone.addEventListener('drop', e => {
      const f = e.dataTransfer.files?.[0];
      if (f) handleFile(f);
    });
    dropZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', e => {
      const f = e.target.files?.[0];
      if (f) handleFile(f);
    });

    // Atualiza dimensões do preview conforme opções
    function updatePageVars() {
      const ps = PAGE_SIZES[pageSizeSel.value];
      const portrait = orientationSel.value === 'portrait';
      const w = portrait ? ps.w : ps.h;
      const h = portrait ? ps.h : ps.w;
      document.documentElement.style.setProperty('--a4w', w + 'px');
      document.documentElement.style.setProperty('--a4h', h + 'px');
      $$('.page').forEach(pg => pg.style.width = w + 'px');
    }
    pageSizeSel.addEventListener('change', () => { updatePageVars(); if (currentFile) renderPreview(currentFile); });
    orientationSel.addEventListener('change', () => { updatePageVars(); if (currentFile) renderPreview(currentFile); });
    marginRange.addEventListener('input', () => { if (currentFile) renderPreview(currentFile); });
    fitToPageChk.addEventListener('change', () => { if (currentFile) renderPreview(currentFile); });

    function clearPreview() {
      preview.innerHTML = '';
      preview.appendChild(emptyPreview);
      emptyPreview.style.display = 'block';
      metaInfo.textContent = 'Nenhum arquivo carregado';
      currentFile = null;
      progress(0);
    }
    btnClear.addEventListener('click', clearPreview);

    function progress(pct) {
      progressBar.style.width = pct + '%';
      progressBar.textContent = Math.round(pct) + '%';
      progressBar.ariaValueNow = Math.round(pct);
    }

    async function handleFile(file) {
      currentFile = file;
      metaInfo.textContent = `${file.name} • ${(file.size / 1024 / 1024).toFixed(2)} MB`;
      await renderPreview(file);
    }

    async function renderPreview(file) {
      emptyPreview.style.display = 'none';
      preview.innerHTML = '';

      // container "renderedContainer" tem largura fixa da página; usamos para gerar PDF paginado
      if (renderedContainer) renderedContainer.remove();
      renderedContainer = document.createElement('div');
      renderedContainer.style.position = 'absolute';
      renderedContainer.style.left = '-99999px';
      renderedContainer.style.top = '0';
      document.body.appendChild(renderedContainer);

      const ext = file.name.split('.').pop().toLowerCase();
      if (['png', 'jpg', 'jpeg', 'webp', 'gif', 'bmp'].includes(ext)) {
        await renderImage(file);
      } else if (ext === 'docx') {
        await renderDocx(file);
      } else if (['html', 'htm', 'txt'].includes(ext)) {
        await renderTextLike(file, ext);
      } else {
        preview.innerHTML = '<div class="empty-state">Formato não suportado. Use imagens, DOCX, HTML ou TXT.</div>';
      }
    }

    function makePage() {
      const marginMM = parseInt(marginRange.value, 10);
      const ps = PAGE_SIZES[pageSizeSel.value];
      const portrait = orientationSel.value === 'portrait';
      const w = portrait ? ps.w : ps.h;
      const h = portrait ? ps.h : ps.w;

      const page = document.createElement('div');
      page.className = 'page';
      page.style.width = w + 'px';
      page.style.minHeight = h + 'px';

      const content = document.createElement('div');
      content.className = 'content';
      content.style.padding = marginMM + 'mm';
      page.appendChild(content);

      return { page, content, w, h };
    }

    async function renderImage(file) {
      const { page, content } = makePage();

      const imgURL = URL.createObjectURL(file);
      const img = new Image();
      img.src = imgURL;
      await img.decode();

      // Ajuste ao tamanho da página
      img.className = 'thumb';
      if (fitToPageChk.checked) {
        img.style.maxWidth = '100%';
        img.style.height = 'auto';
      }

      content.appendChild(img);
      preview.appendChild(page);

      // Também colocar no container de renderização (do PDF)
      const renderClone = page.cloneNode(true);
      renderedContainer.appendChild(renderClone);
    }

    async function renderDocx(file) {
      const { page, content } = makePage();

      // Docx-preview renderiza em um container; ele mesmo cuida de estilos básicos
      const holder = document.createElement('div');
      content.appendChild(holder);

      const arrayBuffer = await file.arrayBuffer();
      // Render no conteúdo (largura limitada pelo .content)
      await window.docx.renderAsync(arrayBuffer, holder, holder, {
        className: 'docx', inWrapper: false, ignoreFonts: true
      });

      preview.appendChild(page);

      // Para o render consolidado (usado para PDF), clonamos apenas o conteúdo real
      const ps = page.cloneNode(true);
      renderedContainer.appendChild(ps);

      // Se o DOCX for longo, o PDF será paginado automaticamente na geração (fatiamento por altura)
    }

    async function renderTextLike(file, ext) {
      const { page, content } = makePage();

      let html = '';
      const raw = await file.text();
      if (ext === 'txt') {
        html = `<pre style="white-space:pre-wrap;word-wrap:break-word;margin:0">${escapeHtml(raw)}</pre>`;
      } else {
        // HTML/HTM – usamos o conteúdo informado
        html = raw;
      }

      // Sanitização simples (evita scripts executarem no preview)
      const safe = stripDangerousTags(html);
      const wrapper = document.createElement('div');
      wrapper.innerHTML = safe;

      content.appendChild(wrapper);
      preview.appendChild(page);

      const ps = page.cloneNode(true);
      renderedContainer.appendChild(ps);
    }

    function escapeHtml(str) {
      return str.replace(/[&<>\"]/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '\"': '&quot;' }[s]));
    }

    function stripDangerousTags(html) {
      // Remove <script>, <style> perigosos e iframes
      const tmp = document.createElement('div');
      tmp.innerHTML = html;
      tmp.querySelectorAll('script, iframe, object, embed').forEach(el => el.remove());
      // Mantém estilos inline, mas remove <style> externos
      tmp.querySelectorAll('style').forEach(el => el.remove());
      return tmp.innerHTML;
    }

    // Conversão para PDF
    btnGenerate.addEventListener('click', async () => {
      if (!renderedContainer || !renderedContainer.children.length) {
        alert('Envie um arquivo para converter.');
        return;
      }

      progress(5);

      const { jsPDF } = window.jspdf;
      const pdfSize = pageSizeSel.value === 'A4' ? 'a4' : 'letter';
      const pdf = new jsPDF({
        orientation: orientationSel.value,
        unit: 'mm',
        format: pdfSize
      });

      const pageWidthMM = pdf.internal.pageSize.getWidth();
      const pageHeightMM = pdf.internal.pageSize.getHeight();

      const pages = renderedContainer.querySelectorAll('.page');
      for (let i = 0; i < pages.length; i++) {
        const canvas = await html2canvas(pages[i], { scale: 2, backgroundColor: '#ffffff' });
        const imgData = canvas.toDataURL('image/jpeg', 0.95);

        if (i > 0) pdf.addPage();
        pdf.addImage(imgData, 'JPEG', 0, 0, pageWidthMM, pageHeightMM);

        progress(5 + (i / pages.length) * 90);
      }

      progress(100);
      const name = (projectName.value || 'documento') + '.pdf';
      pdf.save(name);
    });


    // Inicializa preview com dimensões corretas
    updatePageVars();
  </script>
</body>

</html>